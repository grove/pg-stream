# =============================================================================
# Security Audit — free for public repositories.
#
# Runs cargo-audit to check all Cargo dependencies against the RustSec
# Advisory Database (https://rustsec.org/) for known CVEs.
#
# Results are posted as PR check annotations via rustsec/audit-check.
#
# Runs on: pushes to main that touch dependencies, every PR, and weekly.
# =============================================================================
name: Security audit

on:
  push:
    branches: [main]
    paths:
      - "Cargo.toml"
      - "Cargo.lock"
  pull_request:
    branches: [main]
    paths:
      - "Cargo.toml"
      - "Cargo.lock"
  schedule:
    # Weekly on Monday at 08:00 UTC — catches newly published advisories
    - cron: "0 8 * * 1"
  workflow_dispatch:  # Allow manual runs from the Actions tab

permissions:
  contents: read
  checks: write  # rustsec/audit-check posts results as a GitHub Check Run

jobs:
  audit:
    name: cargo audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Run cargo audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # RUSTSEC-2023-0071: rsa Marvin Attack — pulled in transitively via
          # sqlx -> sqlx-mysql -> rsa, but pg_stream only uses the "postgres"
          # feature of sqlx. sqlx-mysql is never compiled into the extension.
          # Suppress until an upstream fix is available.
          ignore: RUSTSEC-2023-0071
