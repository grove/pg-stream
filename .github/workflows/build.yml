# =============================================================================
# Build Workflow — Compile and produce platform artifacts + Docker image
#
# Manual-only (workflow_dispatch). The automatic Lint workflow handles
# push/PR gating. Run this before releases or when cross-platform
# verification is needed.
#
# Changes from previous version (see plans/infra/GITHUB_ACTIONS_COST.md):
#   - Step 1: paths-ignore retained for optional re-enablement
#   - Step 2: Windows removed (available in manual CI workflow)
#   - Step 3: timeout-minutes on all jobs
#   - Step 4: Reduced artifact retention (5d packages, 3d Docker)
#   - Step 5: Fast check gate before build matrix
#   - Step 6: Docker build skipped when only non-Docker files change
#   - Step 7: Trigger changed to workflow_dispatch (lint.yml is automatic)
# =============================================================================
name: Build

on:
  workflow_dispatch:  # Manual trigger only — run from Actions tab
  # To re-enable automatic runs, uncomment below (with path filters — Step 1):
  # push:
  #   branches: [main]
  #   paths-ignore:
  #     - '**/*.md'
  #     - 'docs/**'
  #     - 'LICENSE'
  #     - '.gitignore'
  #     - 'PLAN*.md'
  #     - 'REPORT*.md'
  #     - 'adrs/**'
  #     - 'plans/**'
  #     - 'coverage/**'
  #     - 'cnpg/**'
  #     - 'scripts/**'
  # pull_request:
  #   branches: [main]
  #   paths-ignore:
  #     - '**/*.md'
  #     - 'docs/**'
  #     - 'LICENSE'
  #     - '.gitignore'
  #     - 'PLAN*.md'
  #     - 'REPORT*.md'
  #     - 'adrs/**'
  #     - 'plans/**'
  #     - 'coverage/**'
  #     - 'cnpg/**'
  #     - 'scripts/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  PG_VERSION: "18"

jobs:
  # ── Quick check gate (Step 5) ───────────────────────────────────────────
  # Fast fmt + clippy + cargo check on Linux only (~2 min).
  # The full build matrix depends on this — if it fails, no platform
  # builds are wasted.
  check:
    name: Quick check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup pgrx environment
        uses: ./.github/actions/setup-pgrx

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Cargo check
        run: cargo check --all-targets --features pg18

      - name: Run clippy
        run: cargo clippy --all-targets --features pg18 -- -D warnings

  # ── Detect changes for conditional Docker build (Step 6) ────────────────
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docker:
              - 'tests/Dockerfile.e2e'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'src/**'
              - 'pg_trickle.control'

  # ── Build matrix (Step 2: Windows removed) ──────────────────────────────
  build:
    name: Build (${{ matrix.artifact_suffix }})
    needs: check
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux-amd64
            archive_ext: tar.gz
          - os: macos-14
            artifact_suffix: macos-arm64
            archive_ext: tar.gz
          # Windows build available via manual CI workflow
    steps:
      - uses: actions/checkout@v4

      - name: Setup pgrx environment
        uses: ./.github/actions/setup-pgrx

      - name: Build extension package
        shell: bash
        run: |
          PG_CONFIG_PATH="$(cargo pgrx info path pg18)/bin/pg_config"
          cargo pgrx package --pg-config "${PG_CONFIG_PATH}"

      - name: Extract version
        id: version
        shell: bash
        run: |
          VERSION=$(cargo metadata --no-deps --format-version=1 \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['packages'][0]['version'])")
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Package version: ${VERSION}"

      - name: Create archive (tar.gz)
        shell: bash
        run: |
          ARCHIVE_NAME="pg_trickle-${{ steps.version.outputs.version }}-pg${PG_VERSION}-${{ matrix.artifact_suffix }}"
          mkdir -p "dist/${ARCHIVE_NAME}"

          # Find and copy the pgrx package output
          PKG_DIR=$(find target/release -maxdepth 1 -name 'pg_trickle-pg*' -type d | head -1)
          if [[ -z "$PKG_DIR" ]]; then
            echo "ERROR: cannot find pgrx package output"
            find target/release -maxdepth 2 -type d
            exit 1
          fi

          cp -r "${PKG_DIR}"/* "dist/${ARCHIVE_NAME}/"
          cp README.md LICENSE INSTALL.md "dist/${ARCHIVE_NAME}/" 2>/dev/null || true

          cd dist
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          echo "Archive created: ${ARCHIVE_NAME}.tar.gz"
          ls -lh "${ARCHIVE_NAME}.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.artifact_suffix }}
          path: dist/*.${{ matrix.archive_ext }}
          retention-days: 5
          if-no-files-found: error

  # ── Docker image build (Step 6: conditional) ────────────────────────────
  build-docker:
    name: Build Docker image
    needs: [check, detect-changes]
    if: needs.detect-changes.outputs.docker == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build E2E Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: tests/Dockerfile.e2e
          tags: pg_trickle_e2e:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image as artifact
        run: |
          docker save pg_trickle_e2e:latest | gzip > pg_trickle_e2e.tar.gz
          ls -lh pg_trickle_e2e.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: pg_trickle_e2e.tar.gz
          retention-days: 3
          compression-level: 0  # already gzipped
