# =============================================================================
# Multi-stage Dockerfile for pg_stream E2E integration tests.
#
# Stage 1 (builder): Compiles the extension from source inside a container
#   with matching PostgreSQL 18 headers, using cargo-pgrx.
#
# Stage 2 (runtime): Copies the compiled artifacts (.so, .control, .sql)
#   into a clean postgres:18.1 image ready for CREATE EXTENSION.
#
# Usage:
#   docker build -t pg_stream_e2e:latest -f tests/Dockerfile.e2e .
#
# The build context must be the project root (parent of tests/).
# =============================================================================

# ── Stage 1: Build the extension ────────────────────────────────────────────
FROM postgres:18.1 AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
        build-essential \
        libreadline-dev \
        zlib1g-dev \
        pkg-config \
        libssl-dev \
        libclang-dev \
        clang \
        postgresql-server-dev-18 \
        ca-certificates \
        git \
    && rm -rf /var/lib/apt/lists/*

# Install Rust toolchain (stable)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
    | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# Install cargo-pgrx (must match the version in Cargo.toml)
RUN cargo install --locked cargo-pgrx --version 0.17.0

# Initialize pgrx for PG 18 using the system pg_config
RUN cargo pgrx init --pg18 /usr/bin/pg_config

# ── Dependency caching layer ────────────────────────────────────────────────
# Copy only the manifests first so that dependency downloads are cached
# separately from source changes.
WORKDIR /build
COPY Cargo.toml ./

# Create minimal stubs so cargo can resolve dependencies & generate lockfile.
# The real source is copied in the next step.
RUN mkdir -p src/bin src/ivm/operators benches && \
    echo '#![allow(warnings)] fn main() {}' > src/bin/pgrx_embed.rs && \
    echo '#![allow(warnings)]' > src/lib.rs && \
    echo '' > src/ivm/mod.rs && \
    echo '' > src/ivm/operators/mod.rs && \
    echo 'fn main() {}' > benches/refresh_bench.rs && \
    echo 'fn main() {}' > benches/diff_operators.rs && \
    cargo generate-lockfile && \
    cargo fetch

# ── Build the real extension ────────────────────────────────────────────────
# Now copy the actual source. This invalidates the cache only when src/ changes.
COPY src/ src/
COPY pg_stream.control ./

# Build the extension package
# pgrx package outputs to target/release/pg_stream-pg18/ with
# the directory structure mirroring the system pg_config paths:
#   /usr/share/postgresql/18/extension/*.control, *--version.sql
#   /usr/lib/postgresql/18/lib/*.so
RUN cargo pgrx package --pg-config /usr/bin/pg_config

# Verify the artifacts were produced
RUN echo "=== Package artifacts ===" && \
    find target/release/pg_stream-pg18 -type f && \
    echo "========================="

# ── Stage 2: Runtime image with extension installed ─────────────────────────
FROM postgres:18.1

LABEL org.opencontainers.image.title="pg_stream E2E test image"
LABEL org.opencontainers.image.description="PostgreSQL 18.1 with pg_stream extension for integration testing"

# Copy extension artifacts from the builder stage
COPY --from=builder \
    /build/target/release/pg_stream-pg18/usr/share/postgresql/18/extension/ \
    /usr/share/postgresql/18/extension/

COPY --from=builder \
    /build/target/release/pg_stream-pg18/usr/lib/postgresql/18/lib/ \
    /usr/lib/postgresql/18/lib/

# Configure shared_preload_libraries so background worker + shared memory work.
# Append to postgresql.conf.sample which is the template for new clusters.
RUN echo "" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "# pg_stream E2E test configuration" >> /usr/share/postgresql/postgresql.conf.sample && \
    echo "shared_preload_libraries = 'pg_stream'" >> /usr/share/postgresql/postgresql.conf.sample

# Verify the extension files are in place
RUN ls -la /usr/share/postgresql/18/extension/pg_stream* && \
    ls -la /usr/lib/postgresql/18/lib/pg_stream*

EXPOSE 5432
